"use strict";(()=>{var e={};e.id=1085,e.ids=[1085],e.modules={8097:e=>{e.exports=require("@sentry/nextjs")},2167:e=>{e.exports=require("axios")},3582:e=>{e.exports=require("cors")},1185:e=>{e.exports=require("mongoose")},1649:e=>{e.exports=require("next-auth/react")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3160:e=>{e.exports=require("next/dist/lib/import-next-warning")},5828:e=>{e.exports=require("uuid")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},5710:(e,t,a)=>{a.r(t),a.d(t,{config:()=>g,default:()=>l,routeModule:()=>m});var r={};a.r(r),a.d(r,{default:()=>d});var s=a(1802),n=a(7153),o=a(6249),u=a(5912),i=a(3300),c=a(5166),$=a(3506);let handler=async(e,t)=>{if(await (0,c.D0)(e,t),"OPTIONS"===e.method){t.status(200).end();return}await (0,$.uD)();let{method:a,query:r}=e,{type:s,startDate:n,endDate:o,period:i="30d"}=r;return"GET"!==a?t.status(u.uT.METHOD_NOT_ALLOWED).json((0,c.OF)({status:!1,message:`Method ${a} not allowed`})):handleAnalyticsRequest(t,s,n,o,i)},handleAnalyticsRequest=async(e,t,a,r,s)=>{try{let n=getDateRange(a,r,s);switch(t){case"revenue":return await getRevenueAnalytics(e,n);case"user-engagement":return await getUserEngagementAnalytics(e,n);case"content-performance":return await getContentPerformanceAnalytics(e,n);case"operational":return await getOperationalMetrics(e,n);case"gamification":return await getGamificationAnalytics(e,n);case"learning-patterns":return await getLearningPatternAnalytics(e,n);case"platform-health":return await getPlatformHealthMetrics(e,n);case"user-sources":return await getUserSourceAnalytics(e,n);default:return e.status(u.uT.BAD_REQUEST).json((0,c.OF)({status:!1,message:"Invalid analytics type"}))}}catch(t){return e.status(u.uT.INTERNAL_SERVER_ERROR).json((0,c.OF)({status:!1,error:t,message:"Error fetching analytics data"}))}},getDateRange=(e,t,a)=>{let r=t?new Date(t):new Date;return{start:new Date(e||r.getTime()-864e5*("7d"===a?7:"30d"===a?30:"90d"===a?90:365)),end:r}},getRevenueAnalytics=async(e,t)=>{let{start:a,end:r}=t,s=await i.Payment.aggregate([{$match:{isPaid:!0,createdAt:{$gte:a,$lte:r}}},{$group:{_id:{year:{$year:"$createdAt"},month:{$month:"$createdAt"},day:{$dayOfMonth:"$createdAt"}},totalRevenue:{$sum:"$amount"},transactionCount:{$sum:1}}},{$sort:{"_id.year":1,"_id.month":1,"_id.day":1}}]),n=await i.Payment.aggregate([{$match:{isPaid:!0,createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$productType",totalRevenue:{$sum:"$amount"},transactionCount:{$sum:1}}}]),o=await i.PrepYatraSubscription.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$type",totalSubscriptions:{$sum:1},totalRevenue:{$sum:"$amount"},activeSubscriptions:{$sum:{$cond:[{$eq:["$isActive",!0]},1,0]}}}}]),$=await i.User.countDocuments({createdAt:{$gte:a,$lte:r}}),d=await i.Payment.distinct("user",{isPaid:!0,createdAt:{$gte:a,$lte:r}}),l=$>0?d.length/$*100:0;return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{revenueTimeSeries:s,productRevenue:n,subscriptionMetrics:o,totalRevenue:n.reduce((e,t)=>e+t.totalRevenue,0),conversionRate:parseFloat(l.toFixed(2)),totalTransactions:n.reduce((e,t)=>e+t.transactionCount,0),averageTransactionValue:n.length>0?n.reduce((e,t)=>e+t.totalRevenue,0)/n.reduce((e,t)=>e+t.transactionCount,0):0}}))},getUserEngagementAnalytics=async(e,t)=>{let{start:a,end:r}=t,s=await i.User.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:{year:{$year:"$createdAt"},month:{$month:"$createdAt"},day:{$dayOfMonth:"$createdAt"}},newUsers:{$sum:1}}},{$sort:{"_id.year":1,"_id.month":1,"_id.day":1}}]),n=await i.User.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$occupation",totalUsers:{$sum:1},onboardedUsers:{$sum:{$cond:[{$eq:["$isOnboarded",!0]},1,0]}}}}]),o=await i.UserCourse.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$courseId",totalEnrollments:{$sum:1},completedCourses:{$sum:{$cond:[{$eq:["$isCompleted",!0]},1,0]}}}},{$lookup:{from:"courses",localField:"_id",foreignField:"_id",as:"course"}},{$unwind:"$course"},{$project:{courseName:"$course.name",completionRate:{$multiply:[{$divide:["$completedCourses","$totalEnrollments"]},100]},totalEnrollments:1,completedCourses:1}}]),$=await i.UserCourse.aggregate([{$match:{updatedAt:{$gte:a,$lte:r}}},{$group:{_id:{hour:{$hour:"$updatedAt"},dayOfWeek:{$dayOfWeek:"$updatedAt"}},activityCount:{$sum:1}}}]);return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{userGrowth:s,engagementByRole:n,courseCompletionRates:o,activityPatterns:$}}))},getContentPerformanceAnalytics=async(e,t)=>{let{start:a,end:r}=t,s=await i.UserCourse.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$courseId",enrollmentCount:{$sum:1},completionCount:{$sum:{$cond:[{$eq:["$isCompleted",!0]},1,0]}}}},{$lookup:{from:"courses",localField:"_id",foreignField:"_id",as:"course"}},{$unwind:"$course"},{$sort:{enrollmentCount:-1}},{$limit:10}]),n=await i.Feedback.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$type",averageRating:{$avg:"$rating"},totalFeedback:{$sum:1},ratings:{$push:"$rating"}}}]),o=await i.UserCourse.aggregate([{$match:{updatedAt:{$gte:a,$lte:r}}},{$unwind:"$chapters"},{$group:{_id:"$chapters.chapterId",totalViews:{$sum:1},completions:{$sum:{$cond:[{$eq:["$chapters.isCompleted",!0]},1,0]}}}},{$project:{completionRate:{$multiply:[{$divide:["$completions","$totalViews"]},100]},totalViews:1,completions:1}},{$sort:{completionRate:-1}}]);return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{popularCourses:s,feedbackAnalysis:n,chapterEngagement:o}}))},getGamificationAnalytics=async(e,t)=>{let{start:a,end:r}=t,s=await i.Gamification.aggregate([{$match:{updatedAt:{$gte:a,$lte:r}}},{$group:{_id:{$switch:{branches:[{case:{$lt:["$points",500]},then:"Beginner (0-499)"},{case:{$lt:["$points",1e3]},then:"Intermediate (500-999)"},{case:{$lt:["$points",2e3]},then:"Advanced (1000-1999)"},{case:{$gte:["$points",2e3]},then:"Expert (2000+)"}],default:"Unknown"}},userCount:{$sum:1},averagePoints:{$avg:"$points"}}}]),n=await i.Gamification.aggregate([{$match:{updatedAt:{$gte:a,$lte:r}}},{$unwind:"$actions"},{$group:{_id:"$actions.actionType",totalActions:{$sum:1},totalPoints:{$sum:"$actions.pointsEarned"},averagePoints:{$avg:"$actions.pointsEarned"}}},{$sort:{totalActions:-1}}]);return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{pointsDistribution:s,actionPerformance:n}}))},getLearningPatternAnalytics=async(e,t)=>{let{start:a,end:r}=t,s=await i.PrepLog.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$user",totalTimeSpent:{$sum:"$timeSpent"},sessionCount:{$sum:1},averageSessionTime:{$avg:"$timeSpent"}}},{$group:{_id:null,totalLearners:{$sum:1},totalTimeSpent:{$sum:"$totalTimeSpent"},averageTimePerLearner:{$avg:"$totalTimeSpent"},averageSessionTime:{$avg:"$averageSessionTime"}}}]),n=await i.PrepLog.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:{user:"$user",date:{$dateToString:{format:"%Y-%m-%d",date:"$createdAt"}}},dailyTime:{$sum:"$timeSpent"}}},{$group:{_id:"$_id.user",activeDays:{$sum:1},totalTime:{$sum:"$dailyTime"}}},{$group:{_id:null,averageActiveDays:{$avg:"$activeDays"},totalActiveLearners:{$sum:1}}}]);return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{learningTimeAnalysis:s,learningStreaks:n}}))},getOperationalMetrics=async(e,t)=>{let{start:a,end:r}=t,s=await i.Notification.countDocuments({createdAt:{$gte:a,$lte:r}}),n=await i.Feedback.countDocuments({createdAt:{$gte:a,$lte:r}}),o=await i.Feedback.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:null,averageRating:{$avg:"$rating"}}}]),$=await Promise.all([i.Course.countDocuments({createdAt:{$gte:a,$lte:r}}),i.Project.countDocuments({createdAt:{$gte:a,$lte:r}}),i.InterviewSheet.countDocuments({createdAt:{$gte:a,$lte:r}}),i.Webinar.countDocuments({createdAt:{$gte:a,$lte:r}})]);return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{totalNotifications:s,totalFeedback:n,averageRating:o[0]?.averageRating||0,contentCreation:{courses:$[0],projects:$[1],interviewSheets:$[2],webinars:$[3]}}}))},getPlatformHealthMetrics=async(e,t)=>{let{start:a,end:r}=t,s=await Promise.all([i.User.countDocuments(),i.Course.countDocuments(),i.UserCourse.countDocuments(),i.Payment.countDocuments(),i.Feedback.countDocuments()]),n=await Promise.all([i.User.countDocuments({createdAt:{$gte:a,$lte:r}}),i.UserCourse.countDocuments({createdAt:{$gte:a,$lte:r}}),i.Payment.countDocuments({createdAt:{$gte:a,$lte:r}}),i.Feedback.countDocuments({createdAt:{$gte:a,$lte:r}})]);return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{dbHealthMetrics:{totalUsers:s[0],totalCourses:s[1],totalEnrollments:s[2],totalPayments:s[3],totalFeedback:s[4]},recentActivity:{newUsers:n[0],newEnrollments:n[1],newPayments:n[2],newFeedback:n[3]}}}))},getUserSourceAnalytics=async(e,t)=>{try{let{start:a,end:r}=t,s=await i.User.aggregate([{$match:{createdAt:{$gte:a,$lte:r}}},{$group:{_id:"$from",userCount:{$sum:1}}},{$sort:{userCount:-1}}]),n=await i.User.countDocuments({createdAt:{$gte:a,$lte:r}}),o=s.map(e=>({source:e._id||"direct",userCount:e.userCount,percentage:n>0?parseFloat((e.userCount/n*100).toFixed(2)):0})),$=o.length>0?o[0]:{source:"direct",userCount:0,percentage:0},d=new Date;d.setDate(d.getDate()-7);let l=await i.User.aggregate([{$match:{createdAt:{$gte:d,$lt:a}}},{$group:{_id:"$from",userCount:{$sum:1}}}]),g=o.map(e=>{let t=l.find(t=>t._id===e.source),a=t?t.userCount:0,r=a>0?parseFloat(((e.userCount-a)/a*100).toFixed(2)):e.userCount>0?100:0;return{...e,growth:r}});return e.status(u.uT.OKAY).json((0,c.OF)({status:!0,data:{sourceBreakdown:g,totalUsers:n,topSource:$?.source,topSourceCount:$?.userCount,topSourcePercentage:$?.percentage,dateRange:{startDate:a.toISOString(),endDate:r.toISOString()}}}))}catch(t){return e.status(u.uT.INTERNAL_SERVER_ERROR).json((0,c.OF)({status:!1,message:"Error fetching user source analytics",error:t}))}},d=handler,l=(0,o.l)(r,"default"),g=(0,o.l)(r,"config"),m=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/v1/admin/analytics",pathname:"/api/v1/admin/analytics",bundlePath:"",filename:""},userland:r})},3506:(e,t,a)=>{a.d(t,{D0:()=>r.D0,uD:()=>r.uD,xM:()=>r.xM});var r=a(7750)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222,5912,5166,9276,7750,3300],()=>__webpack_exec__(5710));module.exports=a})();