"use strict";(()=>{var e={};e.id=2647,e.ids=[2647],e.modules={8097:e=>{e.exports=require("@sentry/nextjs")},2167:e=>{e.exports=require("axios")},3582:e=>{e.exports=require("cors")},1185:e=>{e.exports=require("mongoose")},1649:e=>{e.exports=require("next-auth/react")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3160:e=>{e.exports=require("next/dist/lib/import-next-warning")},5828:e=>{e.exports=require("uuid")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},6679:(e,t,r)=>{r.r(t),r.d(t,{config:()=>E,default:()=>g,routeModule:()=>_});var s={};r.r(s),r.d(s,{config:()=>y,default:()=>f});var a=r(1802),o=r(7153),u=r(6249);let i=require("raw-body");var n=r.n(i),d=r(5912),p=r(3300),l=r(5166),c=r(3506);let m=d._c.CASHFREE_SECRET_KEY,y={api:{bodyParser:!1}},handler=async(e,t)=>(await (0,l.D0)(e,t),await (0,c.uD)(),m)?"POST"===e.method?handleWebhook(e,t):t.status(d.uT.METHOD_NOT_ALLOWED).json((0,l.OF)({status:!1,message:`Method ${e.method} Not Allowed`})):t.status(d.uT.INTERNAL_SERVER_ERROR).json((0,l.OF)({status:!1,message:"Webhook secret configuration missing"})),handleWebhook=async(e,t)=>{try{if(d.n5){let r=e.headers["x-forwarded-for"]||e.socket.remoteAddress,s=Array.isArray(r)?r[0]:r?.split(",")[0];if(!s||!d.hX.includes(s))return t.status(d.uT.UNAUTHORIZED).json((0,l.OF)({status:!1,message:"Unauthorized IP address"}))}let r=await n()(e),s=r.toString("utf8"),a=e.headers["x-webhook-signature"];{if(!a||"string"!=typeof a)return t.status(d.uT.UNAUTHORIZED).json((0,l.OF)({status:!1,message:"Missing webhook signature"}));let{isValid:e,error:r}=(0,l.po)(s,a,m);if(!e)return t.status(d.uT.UNAUTHORIZED).json((0,l.OF)({status:!1,message:r||"Invalid webhook signature"}))}let o=JSON.parse(s),{isValid:u,error:i,data:c}=(0,l.yL)(o);if(!u||!c)return t.status(d.uT.BAD_REQUEST).json((0,l.OF)({status:!1,message:i||"Invalid webhook event"}));let{data:y,error:f}=await (0,p.getPaymentByOrderIdFromDB)(c.order_id);if(f)return t.status(d.uT.NOT_FOUND).json((0,l.OF)({status:!1,message:f}));let{error:g}=await (0,p.updatePaymentStatusToDB)({orderId:c.order_id,paymentId:c.payment_id,status:c.payment_status});if(g)return t.status(d.uT.INTERNAL_SERVER_ERROR).json((0,l.OF)({status:!1,message:g}));if("SUCCESS"===c.payment_status){if("SHIKSHA"===y.productType){let{data:e}=await (0,p.getEnrolledCourseFromDB)({userId:y.user,courseId:y.productId});if(!e){let{error:e}=await (0,p.enrollInACourse)({userId:y.user,courseId:y.productId});e&&console.error("Course enrollment failed after payment:",e)}}if("PREPYATRA"===y.productType){let e=d.Ef[String(y.productId)]||{type:"3Months",duration:1},t=new Date("Lifetime"===e.type?"2099-12-31":Date.now()+2592e6*e.duration),{data:r}=await (0,p.getActiveSubscriptionByUserFromDB)(y.user,e.type);if(r)console.log(`User ${y.user} already has an active ${e.type} subscription`);else{let r=(0,l.FF)(e.type),{error:s}=await (0,p.createSubscriptionInDB)({userId:y.user,type:e.type,amount:y.amount,duration:e.duration,expiryDate:t,features:r});if(s)console.error("Failed to create subscription:",s);else{let{error:r}=await (0,p.updateUserSubscriptionStatusInDB)({userId:y.user,subscriptionStatus:"Active",subscriptionExpiry:t});r?console.error("Failed to update user subscription status:",r):console.log(`Successfully created ${e.type} subscription for user ${y.user}`)}}}}return t.status(d.uT.OKAY).json({status:"OK"})}catch(e){return t.status(d.uT.INTERNAL_SERVER_ERROR).json((0,l.OF)({status:!1,message:"Webhook processing failed",error:d.aD&&e}))}},f=handler,g=(0,u.l)(s,"default"),E=(0,u.l)(s,"config"),_=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/v1/payment/webhook",pathname:"/api/v1/payment/webhook",bundlePath:"",filename:""},userland:s})},3506:(e,t,r)=>{r.d(t,{D0:()=>s.D0,uD:()=>s.uD,xM:()=>s.xM});var s=r(7750)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[4222,5912,5166,9276,7750,3300],()=>__webpack_exec__(6679));module.exports=r})();